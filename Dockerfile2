FROM debian:bullseye


# Update Ubuntu Software repository.
RUN apt update -y \
    && apt upgrade -y \
    && apt install -y --no-install-recommends ca-certificates git build-essential procps curl file git nano sudo ncdu gcc postgresql libpq-dev make \
    && sudo update-ca-certificates \
    && rm -rf /var/lib/apt/lists/*


WORKDIR /Samfundet
COPY . /Samfundet


### brew ###
# Clone repo, add to path, and update.
RUN git clone https://github.com/Homebrew/brew /.linuxbrew/Homebrew
ENV PATH=/.linuxbrew/Homebrew/bin:$PATH
RUN brew update && brew upgrade && brew upgrade --cask && brew install gcc

### ruby ###
RUN brew install imagemagick
RUN brew install graphviz
RUN brew install rbenv
RUN eval "$(rbenv init - bash)"

RUN OPENSSL_CFLAGS=-Wno-error=implicit-function-declaration rbenv install \
    && gem install bundler:1.17.3 \
    && bundle install

RUN cp config/database.example.yml config/database.yml \
    && cp config/local_env.example.yml config/local_env.yml \
    && cp config/billig.example.yml config/billig.yml \
    && cp config/secrets.example.yml config/secrets.yml \
    && cp .env.example .env

RUN bundle exec rake db:setup

CMD bundle exec rails server


### Commands: ###
# Only build.
# docker build -t samfundet/samfundet .

# Only start container.
# docker run --name samfundet-samfundet -p 8000:8000 -it samfundet/samfundet

# Build and run.
# docker build -t samfundet/samfundet . && docker run --name samfundet-samfundet -p 8000:8000 -it samfundet/samfundet

# Spawn interactive shell in already running container.
# docker exec -it samfundet-samfundet bash


# If user is needed.
# RUN adduser emilte && adduser emilte sudo
# RUN echo "emilte:emilte"|chpasswd
# USER emilte
